name: Competitor Monitor

on:
  schedule:
    # Every Monday at 8 AM UTC (weekly monitoring)
    - cron: '0 8 * * 1'
  
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force crawl even if not Monday'
        type: boolean
        default: false
        required: false

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
  SMTP_HOST: ${{ secrets.SMTP_HOST }}
  SMTP_PORT: ${{ secrets.SMTP_PORT }}
  SMTP_USER: ${{ secrets.SMTP_USER }}
  SMTP_PASS: ${{ secrets.SMTP_PASS }}
  EMAIL_FROM: ${{ secrets.EMAIL_FROM }}

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Run Competitor Monitor Workflow
        id: monitor
        run: |
          # Execute the workflow via Claude Code
          claude -p workflow.md
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_MODEL: ${{ vars.MODEL || 'claude-sonnet-4-20250514' }}
          CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: true
      
      - name: Commit and push results
        if: success()
        run: |
          # Check if there are changes to commit
          if [ -n "$(git status --porcelain)" ]; then
            # Stage only the expected output files
            git add reports/*.md || true
            git add state/snapshots/*/*.json || true
            
            # Verify something was staged
            if [ -n "$(git diff --cached --name-only)" ]; then
              # Get report date
              REPORT_DATE=$(date -u +%Y-%m-%d)
              
              # Count changes across all competitors
              TOTAL_CHANGES=0
              if compgen -G "/tmp/changes-*.json" > /dev/null; then
                TOTAL_CHANGES=$(jq -s 'map(.summary | .new_posts_count + .pricing_changes_count + .new_features_count) | add' /tmp/changes-*.json 2>/dev/null || echo "0")
              fi
              
              # Count competitors
              COMPETITOR_COUNT=$(jq '.competitors | length' config/competitors.json 2>/dev/null || echo "unknown")
              
              # Commit with detailed message
              git commit -m "chore: competitor monitor report - $REPORT_DATE

- Monitored: $COMPETITOR_COUNT competitors
- Changes detected: $TOTAL_CHANGES
- Report: reports/$REPORT_DATE.md
- Generated by GitHub Actions workflow"
              
              # Push with retry
              MAX_RETRIES=3
              RETRY_COUNT=0
              
              while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if git push origin main; then
                  echo "✓ Results pushed successfully"
                  exit 0
                else
                  RETRY_COUNT=$((RETRY_COUNT + 1))
                  echo "Push failed (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  
                  if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                    echo "Retrying in 10 seconds..."
                    sleep 10
                    git pull --rebase origin main || true
                  fi
                fi
              done
              
              echo "✗ Failed to push after $MAX_RETRIES attempts"
              exit 1
            else
              echo "No changes to commit (workflow produced no output)"
            fi
          else
            echo "No changes detected (workflow produced no output)"
          fi
      
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_number }}
          path: |
            /tmp/snapshot-*.json
            /tmp/changes-*.json
            /tmp/report-*.json
            *.log
          retention-days: 7
          if-no-files-found: ignore
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Competitor monitor workflow failed. Check logs for details."
          echo "Run ID: ${{ github.run_id }}"
          echo "Run Number: ${{ github.run_number }}"
