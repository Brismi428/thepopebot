name: Agent HQ

on:
  issues:
    types: [opened, assigned]
  issue_comment:
    types: [created]

jobs:
  handle_issue:
    if: |
      (github.event_name == 'issues' && (github.event.issue.assignee.login == 'claude' || contains(github.event.issue.labels.*.name, 'agent-task'))) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install anthropic

      - name: Parse issue body as task
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';
            
            // Check if body contains JSON invoice data
            const jsonMatch = body.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch) {
              const invoiceData = jsonMatch[1].trim();
              core.setOutput('has_invoice', 'true');
              core.setOutput('invoice_json', invoiceData);
              return;
            }
            
            // Otherwise, treat as a general request
            core.setOutput('has_invoice', 'false');
            core.setOutput('issue_text', body);

      - name: Generate invoice from issue
        if: steps.parse.outputs.has_invoice == 'true'
        run: |
          echo '${{ steps.parse.outputs.invoice_json }}' | \
            gh workflow run generate_invoice.yml \
              --ref ${{ github.ref }} \
              --field invoice_json="$(cat)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on issue
        if: steps.parse.outputs.has_invoice == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ”„ Invoice generation workflow triggered. I\'ll update this issue when complete.'
            });

      - name: Handle general task (Claude API)
        if: steps.parse.outputs.has_invoice == 'false'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python - << 'EOF'
          import os
          import json
          from anthropic import Anthropic
          
          client = Anthropic(api_key=os.environ["ANTHROPIC_API_KEY"])
          
          system_prompt = open("CLAUDE.md").read()
          user_prompt = """${{ steps.parse.outputs.issue_text }}"""
          
          message = client.messages.create(
              model="claude-sonnet-4-20250514",
              max_tokens=4096,
              system=system_prompt,
              messages=[{"role": "user", "content": user_prompt}]
          )
          
          response = message.content[0].text
          print(response)
          
          # Save response to file for comment
          with open("agent_response.txt", "w") as f:
              f.write(response)
          EOF

      - name: Comment with Claude response
        if: steps.parse.outputs.has_invoice == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const response = fs.readFileSync('agent_response.txt', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: response
            });
