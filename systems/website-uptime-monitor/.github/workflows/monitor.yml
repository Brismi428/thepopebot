name: Website Uptime Monitor

on:
  # Primary trigger: every 5 minutes
  schedule:
    - cron: '*/5 * * * *'
  
  # Manual trigger with optional URL override
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to check (optional - overrides default)'
        required: false
        type: string
      timeout:
        description: 'Request timeout in seconds'
        required: false
        type: number
        default: 10

# Prevent concurrent runs to avoid git conflicts
concurrency:
  group: uptime-monitor
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Determine URL to check
        id: set-url
        run: |
          # Use workflow input if provided, otherwise use default
          if [ -n "${{ github.event.inputs.url }}" ]; then
            echo "URL=${{ github.event.inputs.url }}" >> $GITHUB_ENV
          else
            echo "URL=${URL:-https://example.com}" >> $GITHUB_ENV
          fi
          
          # Set timeout
          if [ -n "${{ github.event.inputs.timeout }}" ]; then
            echo "TIMEOUT=${{ github.event.inputs.timeout }}" >> $GITHUB_ENV
          else
            echo "TIMEOUT=${TIMEOUT:-10}" >> $GITHUB_ENV
          fi
        env:
          URL: ${{ vars.MONITOR_URL }}
          TIMEOUT: ${{ vars.MONITOR_TIMEOUT }}
      
      - name: Run uptime check
        id: check
        run: |
          python tools/monitor.py \
            --url "${{ env.URL }}" \
            --timeout "${{ env.TIMEOUT }}"
        continue-on-error: true
      
      - name: Commit results
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if there are changes
          if git diff --quiet data/uptime_log.csv; then
            echo "No changes to commit"
            exit 0
          fi
          
          # Stage only the CSV file
          git add data/uptime_log.csv
          
          # Determine status for commit message
          if [ "${{ steps.check.outcome }}" == "success" ]; then
            STATUS="UP"
          else
            STATUS="DOWN"
          fi
          
          # Commit with descriptive message
          git commit -m "Uptime check: ${STATUS} ${{ env.URL }} at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          
          # Push with retry logic for race conditions
          for i in {1..3}; do
            if git push; then
              echo "Push succeeded on attempt $i"
              break
            else
              if [ $i -lt 3 ]; then
                echo "Push failed, retrying after rebase..."
                git pull --rebase origin ${{ github.ref_name }}
                sleep 2
              else
                echo "Push failed after 3 attempts"
                exit 1
              fi
            fi
          done
      
      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.check.outcome }}" == "success" ]; then
            echo "✅ Site is UP: ${{ env.URL }}"
            exit 0
          else
            echo "❌ Site is DOWN: ${{ env.URL }}"
            exit 1
          fi
