name: "company-profiler — Agent HQ"

on:
  issues:
    types: [opened, assigned]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  agent-hq:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: >
      (github.event_name == 'issues' && contains(github.event.issue.assignees.*.login, 'claude')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude'))

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Parse task from issue/comment
        id: task
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "source=issue" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            echo "source=comment" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request_review_comment" ]; then
            echo "source=pr_review" >> $GITHUB_OUTPUT
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "body<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.comment.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Post acknowledgment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ steps.task.outputs.number }} \
            --body "**company-profiler** agent is processing this request...

          - [ ] Parsing company URL from request
          - [ ] Scraping website
          - [ ] Extracting business information
          - [ ] Generating profile JSON"

      - name: Execute via Claude Code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FIRECRAWL_API_KEY: ${{ secrets.FIRECRAWL_API_KEY }}
          BRAVE_SEARCH_API_KEY: ${{ secrets.BRAVE_SEARCH_API_KEY }}
          TASK_BODY: ${{ steps.task.outputs.body }}
          ISSUE_NUMBER: ${{ steps.task.outputs.number }}
        run: |
          npx @anthropic-ai/claude-code --print \
            "Read CLAUDE.md for system context. \
             Execute workflow.md with the following task input: \
             $TASK_BODY \
             \
             Extract the company URL from the task input and profile it. \
             Commit results to output/ directory."

      - name: Create/update results PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="agent-hq/issue-${{ steps.task.outputs.number }}"
          git config user.name "company-profiler Agent HQ"
          git config user.email "wat-agent-hq@users.noreply.github.com"

          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
          else
            git checkout -b "$BRANCH"
          fi

          git add output/ || true
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "agent-hq: company profile for #${{ steps.task.outputs.number }}"
          git push origin "$BRANCH"

          EXISTING=$(gh pr list --head "$BRANCH" --json number -q '.[0].number' || echo "")
          if [ -z "$EXISTING" ]; then
            gh pr create \
              --title "Company Profile: ${{ steps.task.outputs.title }}" \
              --body "Company profile results for #${{ steps.task.outputs.number }}.

          Closes #${{ steps.task.outputs.number }}

          ---
          *Generated by company-profiler via Agent HQ*" \
              --base main --head "$BRANCH" --draft
          fi

      - name: Update status
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            MSG="Done — company profile is in the linked PR for review."
          else
            MSG="Failed — check [logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          fi
          gh issue comment ${{ steps.task.outputs.number }} --body "**company-profiler** agent: $MSG"
